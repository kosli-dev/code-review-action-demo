name: Attest Source Controls

on:
  push:
    branches:
      - 'main'

env:
  KOSLI_ORG: kosli-public
  KOSLI_FLOW: test-code-review-action
  KOSLI_API_TOKEN: '${{ secrets.KOSLI_PUBLIC_API_TOKEN }}'

jobs:
  report-pull-request:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Kosli cli
        uses: kosli-dev/setup-cli-action@v2
        with:
          version: ${{ vars.KOSLI_CLI_VERSION }}

      - name: Create Kosli Flow
        run: kosli create flow ${{ env.KOSLI_FLOW }}
          --template-file build-template.yml
          --description "Code Review Demo"

      - name: Begin Kosli Trail
        run: kosli begin trail "${{ github.sha }}"
          --flow ${{ env.KOSLI_FLOW }}

      - name: Attest pull-request evidence to Kosli
        run: kosli attest pullrequest github
          --name pull-request
          --flow ${{ env.KOSLI_FLOW }}
          --trail ${{ github.sha }}
          --github-token ${{ secrets.GITHUB_TOKEN }}
